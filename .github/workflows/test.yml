name: Test
on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
  all-tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.2.0
        
    - name: Install Dependencies
      run: npm i --prefix topics-project

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Build Application
      run: npm run build --prefix topics-project
      
    - name: Run unit and integration tests
      run: npm run test --prefix topics-project

    - name: Generate Code Coverage Report
      run: npm run test --prefix topics-project -- --coverage

    - name: Run e2e Tests
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_KEY }}
      working-directory: topics-project
      run: npx playwright test
